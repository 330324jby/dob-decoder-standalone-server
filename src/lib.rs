pub mod decoder;
pub mod types;

#[cfg(feature = "embeded_vm")]
mod vm;

#[cfg(test)]
mod test {
    use ckb_types::{h256, H256};

    use crate::decoder::{DOBDecoder, DOBThreadDecoder};
    use crate::types::{
        ClusterDescriptionField, DOBClusterFormat, DOBDecoderFormat, DecoderLocationType, Settings,
        SporeContentField,
    };

    const EXPECTED_RENDER_RESULT: &str = "[{\"name\":\"horn\",\"traits\":[{\"String\":\"Gold\"}]},{\"name\":\"wings\",\"traits\":[{\"String\":\"Colorful\"}]},{\"name\":\"body\",\"traits\":[{\"String\":\"White Water\"}]},{\"name\":\"tail\",\"traits\":[{\"String\":\"Colorful\"}]},{\"name\":\"hair\",\"traits\":[{\"String\":\"Yang-Short\"}]},{\"name\":\"horseshoes\",\"traits\":[{\"String\":\"White\"}]},{\"name\":\"talent\",\"traits\":[{\"String\":\"Crown\"}]},{\"name\":\"hp\",\"traits\":[{\"Number\":59576}]},{\"name\":\"lucky\",\"traits\":[{\"Number\":3}]}]";
    const HEXED_SPORE_ID: &str = "0e61cc8eb420ce4ae44c922bfd17bc12204cf95f017a030f5a108d01339feb78";
    const SPORE_ID: H256 =
        h256!("0x0e61cc8eb420ce4ae44c922bfd17bc12204cf95f017a030f5a108d01339feb78");

    fn prepare_settings(version: &str) -> Settings {
        Settings {
            ckb_rpc: "https://testnet.ckbapp.dev/".to_string(),
            protocol_version: version.to_string(),
            ckb_vm_runner: "ckb-vm-runner".to_string(),
            decoders_cache_directory: "cache/decoders".parse().unwrap(),
            dobs_cache_directory: "cache/dobs".parse().unwrap(),
            avaliable_spore_code_hashes: vec![
                h256!("0x685a60219309029d01310311dba953d67029170ca4848a4ff638e57002130a0d"),
                h256!("0x5e063b4c0e7abeaa6a428df3b693521a3050934cf3b0ae97a800d1bc31449398"),
            ],
            avaliable_cluster_code_hashes: vec![
                h256!("0x0bbe768b519d8ea7b96d58f1182eb7e6ef96c541fbd9526975077ee09f049058"),
                h256!("0x7366a61534fa7c7e6225ecc0d828ea3b5366adec2b58206f2ee84995fe030075"),
            ],
            ..Default::default()
        }
    }

    fn generate_nervape_dob_ingredients(
        onchain_decoder: bool,
    ) -> (SporeContentField, ClusterDescriptionField) {
        let nervape_content = SporeContentField {
            id: Some(145),
            dna: "cde3feaaec35bdaf997e0ea5e74ef046".to_string(),
            block_number: None,
            cell_id: None,
        };
        let decoder = if onchain_decoder {
            DOBDecoderFormat {
                location: DecoderLocationType::TypeId,
                hash: h256!("0x11b80e7161c4eed1101e52a5835e9f58008334bc75d5561fefcc62ccc56221cf"),
            }
        } else {
            DOBDecoderFormat {
                location: DecoderLocationType::CodeHash,
                hash: h256!("0xedbb2d19515ebbf69be66b2178b0c4c0884fdb33878bd04a5ad68736a6af74f8"),
            }
        };
        let nervape_metadata = ClusterDescriptionField {
            description: "Nervape Collection".to_string(),
            dob: DOBClusterFormat {
                ver: Some(0),
                decoder,
                pattern: "820900004400000086000000360500004106000084060000c1060000040700004707000088070000c5070000050800004308000080080000bf0800000109000042090000420000000c0000001900000009000000707265762e747970652900000008000000210000000c0000000d000000010000000010000000080000000400000074657874b00400000c0000001700000007000000707265762e62679904000008000000910400000c0000000d0000000100000000800400003c0000008a000000d80000002601000074010000c2010000100200005e020000ac020000fa0200004803000096030000e4030000320400004a00000062746366733a2f2f3162633234333531613064663265363836353734636431623633343661316635356638316366663061326535323037386136653361643061333563666238333369304a00000062746366733a2f2f3634663536326431366532613461323965386334383231333730666666343733656466613232633236656635383038616462323430346533396463303133653569304a00000062746366733a2f2f6332396665636436643764376565633063623361326233646664636236616132363038316462386639383531313130623763323061306633633631373239396169304a00000062746366733a2f2f3539653837636131373765663066643435376538376539663933363237363630303232636635313962353331653166346533613664646139653565333338323769304a00000062746366733a2f2f6133353839646463663462376133633664613532666536616534656433323936663165646531333966653931323766323639376365306463663237303362363169304a00000062746366733a2f2f3739393732396666366131366464366166353764623161386361363134366435363733613330616439613539373664643836316433343861356565633238633469304a00000062746366733a2f2f3838646432616230356262386639633732646134326166633730363737616330356634373665313765306631363535316463303036333561653765393534366569304a00000062746366733a2f2f6233326533626262373363623837376339623431313532393933306135623665623332383039323762323832633132343836636532363930316233633232393169304a00000062746366733a2f2f6138623139646461623333386462306335326639613238346237643935666665616130646533346530623837343137373930316562393265306639663964386469304a00000062746366733a2f2f6261386231626239643862616565346266323461303666616132356235363934313066326462393662343633396638653038636362656330356338386437396269304a00000062746366733a2f2f6161383938366630656636363738303764346232333937306536343834346464653366303632323534326237396135633330323533396465306333356233316569304a00000062746366733a2f2f3130306637653066303936356463353435313561333833316133323038383133313563663563613634616430316265643262343232363136623135666433313469304a00000062746366733a2f2f6238346563306337373061613139363161336439343938656138613637653132383235333239313366633163313365336561663561343864653231363466623969304a00000062746366733a2f2f6130366261326531363134613530393931373665356363346439356465373663626562343730356138626437653134323333363237386562633239306664623369300b0100000c0000001c0000000c000000707265762e6267636f6c6f72ef00000008000000e70000000c0000000d0000000100000000d60000003c00000047000000520000005d00000068000000730000007e00000089000000940000009f000000aa000000b5000000c0000000cb00000007000000234646453345420700000023464643324645070000002343454241463707000000234237453646390700000023414246344430070000002345304446424407000000234639463741370700000023453242453931070000002346394336363207000000234637443642320700000023464341383633070000002346394143414307000000234530453145320700000023413341374141430000000c0000001a0000000a0000004261636b67726f756e642900000008000000210000000c0000000d00000001030000000000000000000000ff000000000000003d0000000c0000001400000004000000537569742900000008000000210000000c0000000d00000001030000000000000000000000ff00000000000000430000000c0000001a0000000a000000557070657220626f64792900000008000000210000000c0000000d00000001030000000000000000000000ff00000000000000430000000c0000001a0000000a0000004c6f77657220626f64792900000008000000210000000c0000000d00000001030000000000000000000000ff00000000000000410000000c000000180000000800000048656164776561722900000008000000210000000c0000000d00000001030000000000000000000000ff000000000000003d0000000c00000014000000040000004d61736b2900000008000000210000000c0000000d00000001030000000000000000000000ff00000000000000400000000c0000001700000007000000457965776561722900000008000000210000000c0000000d00000001030000000000000000000000ff000000000000003e0000000c00000015000000050000004d6f7574682900000008000000210000000c0000000d00000001030000000000000000000000ff000000000000003d0000000c0000001400000004000000456172732900000008000000210000000c0000000d00000001030000000000000000000000ff000000000000003f0000000c0000001600000006000000546174746f6f2900000008000000210000000c0000000d00000001030000000000000000000000ff00000000000000420000000c00000019000000090000004163636573736f72792900000008000000210000000c0000000d00000001030000000000000000000000ff00000000000000410000000c000000180000000800000048616e6468656c642900000008000000210000000c0000000d00000001030000000000000000000000ff00000000000000400000000c00000017000000070000005370656369616c2900000008000000210000000c0000000d00000001030000000000000000000000ff00000000000000".to_string(),
                dna_bytes: 16,
            },
        };
        (nervape_content, nervape_metadata)
    }

    fn generate_unicorn_dob_ingredients(
        onchain_decoder: bool,
    ) -> (SporeContentField, ClusterDescriptionField) {
        let unicorn_content = SporeContentField {
            id: None,
            block_number: Some(120),
            cell_id: Some(11844),
            dna: "44f24502b672369f94808892".to_string(),
        };
        let decoder = if onchain_decoder {
            DOBDecoderFormat {
                location: DecoderLocationType::TypeId,
                hash: h256!("0x11b80e7161c4eed1101e52a5835e9f58008334bc75d5561fefcc62ccc56221cf"),
            }
        } else {
            DOBDecoderFormat {
                location: DecoderLocationType::CodeHash,
                hash: h256!("0xedbb2d19515ebbf69be66b2178b0c4c0884fdb33878bd04a5ad68736a6af74f8"),
            }
        };
        let unicorn_metadata = ClusterDescriptionField {
            description: "Unicorn Collection".to_string(),
            dob: DOBClusterFormat {
                ver: None,
                decoder,
                pattern: "0a04000028000000990000000b01000098010000090200005c020000d302000091030000cc030000710000000c0000001400000004000000686f726e5d00000008000000550000000c0000000d000000010000000044000000180000002000000027000000330000003b00000004000000426c75650300000052656408000000436f6c6f7266756c04000000476f6c64050000005768697465720000000c000000150000000500000077696e67735d00000008000000550000000c0000000d000000010000000044000000180000002000000027000000330000003b00000004000000426c75650300000052656408000000436f6c6f7266756c04000000476f6c640500000057686974658d0000000c0000001400000004000000626f64797900000008000000710000000c0000000d000000010000000060000000180000002500000031000000430000005100000009000000426c756520576f6f640800000052656420466972650e000000436f6c6f7266756c2045617274680a000000476f6c64204d6574616c0b0000005768697465205761746572710000000c00000014000000040000007461696c5d00000008000000550000000c0000000d000000010000000044000000180000002000000027000000330000003b00000004000000426c75650300000052656408000000436f6c6f7266756c04000000476f6c64050000005768697465530000000c0000001400000004000000686169723f00000008000000370000000c0000000d0000000100000000260000000c0000001a0000000a00000059616e672d53686f72740800000059696e2d4c6f6e67770000000c0000001a0000000a000000686f72736573686f65735d00000008000000550000000c0000000d000000010000000044000000180000002000000027000000330000003b00000004000000426c75650300000052656408000000436f6c6f7266756c04000000476f6c64050000005768697465be0000000c000000160000000600000074616c656e74a800000008000000a00000000c0000000d00000001000000008f0000002c00000037000000400000004b000000540000005d00000067000000700000007a00000085000000070000005265766976616c0500000044656174680700000050726f706865740500000043757273650500000043726f776e060000004865726d69740500000047756172640600000041747461636b0700000043616c6c696e6706000000466f726765743b0000000c000000120000000200000068702900000008000000210000000c0000000d000000040300000050c3000000000000a0860100000000003e0000000c00000015000000050000006c75636b792900000008000000210000000c0000000d000000010300000001000000000000003100000000000000".to_string(),
                dna_bytes: 12,
            },
        };
        (unicorn_content, unicorn_metadata)
    }

    fn decode_unicorn_dna(onchain_decoder: bool) -> String {
        let settings = prepare_settings("text/plain");
        let decoder = DOBDecoder::new(settings);
        let (unicorn_content, unicorn_metadata) = generate_unicorn_dob_ingredients(onchain_decoder);
        decoder
            .decode_dna(&unicorn_content, unicorn_metadata)
            .expect("decode")
    }

    #[test]
    fn test_decode_unicorn_dna() {
        let render_result = decode_unicorn_dna(false);
        assert_eq!(render_result, EXPECTED_RENDER_RESULT);
    }

    #[test]
    fn test_decode_unicorn_dna_with_onchain_decoder() {
        let render_result = decode_unicorn_dna(true);
        assert_eq!(render_result, EXPECTED_RENDER_RESULT);
    }

    #[test]
    fn test_fetch_and_decode_unicorn_dna() {
        let settings = prepare_settings("text/plain");
        let decoder = DOBDecoder::new(settings);
        let (dob_content, dob_metadata) = decoder
            .fetch_decode_ingredients(SPORE_ID.into())
            .expect("fetch");
        let render_result = decoder
            .decode_dna(&dob_content, dob_metadata)
            .expect("decode");
        assert_eq!(render_result, EXPECTED_RENDER_RESULT);
    }

    #[test]
    #[should_panic = "fetch: DOBVersionUnexpected"]
    fn test_fetch_onchain_dob_failed() {
        let settings = prepare_settings("dob/0");
        DOBDecoder::new(settings)
            .fetch_decode_ingredients(SPORE_ID.into())
            .expect("fetch");
    }

    #[test]
    fn test_decode_onchain_unicorn_dna_in_thread() {
        let protocol_version = "text/plain";
        let settings = prepare_settings(protocol_version);
        let (decoder, cmd) = DOBThreadDecoder::new(settings);
        decoder.run();
        assert_eq!(cmd.protocol_version(), protocol_version);
        let (render_result, _) = cmd.decode_dna(HEXED_SPORE_ID).expect("thread decode");
        assert_eq!(render_result, EXPECTED_RENDER_RESULT);
        cmd.stop();
    }

    #[test]
    fn test_nervape_json_serde() {
        let (nervape_content, nervape_metadata) = generate_nervape_dob_ingredients(false);
        let json_unicorn_content = serde_json::to_string(&nervape_content).unwrap();
        let json_unicorn_metadata = serde_json::to_string(&nervape_metadata).unwrap();
        println!("[spore_content] = {json_unicorn_content}");
        println!("[cluster_description] = {json_unicorn_metadata}");
        let deser_unicorn_content: SporeContentField =
            serde_json::from_slice(json_unicorn_content.as_bytes()).unwrap();
        let deser_unicorn_metadata: ClusterDescriptionField =
            serde_json::from_slice(json_unicorn_metadata.as_bytes()).unwrap();
        assert_eq!(nervape_content, deser_unicorn_content);
        assert_eq!(nervape_metadata, deser_unicorn_metadata);
    }

    #[test]
    fn test_unicorn_json_serde() {
        let (unicorn_content, unicorn_metadata) = generate_unicorn_dob_ingredients(true);
        let json_unicorn_content = serde_json::to_string(&unicorn_content).unwrap();
        let json_unicorn_metadata = serde_json::to_string(&unicorn_metadata).unwrap();
        println!("[spore_content] = {json_unicorn_content}");
        println!("[cluster_description] = {json_unicorn_metadata}");
        let deser_unicorn_content: SporeContentField =
            serde_json::from_slice(json_unicorn_content.as_bytes()).unwrap();
        let deser_unicorn_metadata: ClusterDescriptionField =
            serde_json::from_slice(json_unicorn_metadata.as_bytes()).unwrap();
        assert_eq!(unicorn_content, deser_unicorn_content);
        assert_eq!(unicorn_metadata, deser_unicorn_metadata);
    }
}
